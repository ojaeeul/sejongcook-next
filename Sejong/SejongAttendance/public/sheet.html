<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>월간 출석부 - 세종요리</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        .sheet-container {
            background: white;
            padding: 24px;
            max-width: 100%;
            margin: 0 auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            overflow-x: auto;
        }

        .sheet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .month-nav {
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }

        .month-nav button {
            background: none;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            padding: 2px 6px;
            font-size: 0.8rem;
            color: #64748b;
        }

        .sheet-title {
            font-size: 1.1rem;
            margin: 0;
            font-weight: 700;
            text-align: center;
            color: #1e293b;
        }

        .legend {
            display: flex;
            gap: 12px;
            font-size: 0.75rem;
            color: #475569;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .symbol {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.7rem;
            padding: 0 4px;
            min-width: 18px;
            height: 18px;
            border-radius: 4px;
            border: 1px solid #cbd5e1;
            line-height: 1;
        }

        table.attendance-table {
            width: max-content;
            min-width: 100%;
            margin: 0 auto;
            border-collapse: collapse;
            font-size: 0.75rem;
            table-layout: fixed;
            border: 1px solid #cbd5e1;
        }

        table.attendance-table th,
        table.attendance-table td {
            border: 1px solid #e2e8f0;
            text-align: center;
            padding: 0;
            height: 28px;
            vertical-align: middle;
            color: #334155;
        }

        table.attendance-table th {
            font-weight: 600;
            color: #475569;
            background-color: #f8fafc;
            height: 38px;
            line-height: 1.2;
            border-bottom: 1px solid #cbd5e1;
        }

        /* Column Widths Compact */
        .col-course {
            width: 120px;
        }

        .col-name {
            width: 80px;
        }

        .col-no {
            width: 40px;
        }

        .col-day {
            width: 22px;
            min-width: 20px;
            cursor: pointer;
        }

        .col-note {
            width: 80px;
        }

        .col-day.is-sunday {
            color: #EF4444;
            background-color: #FEF2F2;
        }

        .col-day.is-saturday {
            color: #3B82F6;
            background-color: #EFF6FF;
        }

        .is-holiday-col {
            background-color: #FEE2E2 !important;
            color: #EF4444;
        }

        td.cell-disabled {
            background-color: #f1f5f9 !important;
            cursor: not-allowed !important;
            pointer-events: none;
        }

        .cell-check {
            cursor: pointer;
            font-weight: bold;
            font-size: 0.8rem;
            transition: background 0.1s;
        }

        .cell-check:hover {
            background-color: #f0f9ff;
        }

        /* Status Styles */
        .stat-present {
            color: var(--status-success);
        }

        .stat-absent {
            color: var(--status-error);
        }

        .stat-extension {
            color: #d97706;
            background-color: #ffedd5;
        }

        .stat-text {
            color: #334155;
        }

        /* Tab Styles */
        .course-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }

        .tab-btn {
            background: white;
            border: 1px solid #e2e8f0;
            padding: 6px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            color: #64748b;
            transition: all 0.2s;
            font-weight: 500;
        }

        .tab-btn:hover {
            background: #f8fafc;
            color: #334155;
        }

        .tab-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            font-weight: 600;
        }

        .print-btn {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background-color: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            border: none;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .help-tip {
            margin-top: 8px;
            font-size: 0.75rem;
            color: #94a3b8;
            text-align: left;
        }

        @media print {
            @page {
                size: landscape;
                margin-top: 5mm;
                margin-bottom: 5mm;
                margin-left: 4.5mm;
                /* 2mm + 2.5mm more */
                margin-right: 5mm;
            }

            body {
                background: white;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                font-size: 9pt;
                margin: 0;
                padding: 0;
                /* Remove padding to allow full control via @page */
            }

            /* Hide UI Elements */
            .sidebar,
            .top-header,
            .print-btn,
            .month-nav button,
            .help-tip,
            .legend,
            .course-tabs {
                display: none !important;
            }

            /* Reset Containers */
            .app-container,
            .main-wrapper,
            .content-scroll,
            .sheet-container {
                display: block !important;
                width: 100% !important;
                max-width: 100% !important;
                padding: 0 !important;
                margin: 0 !important;
                border: none !important;
                box-shadow: none !important;
                overflow: visible !important;
                height: auto !important;
            }

            /* Header adjustments */
            .sheet-header {
                margin-bottom: 5px;
                padding-bottom: 0;
                border: none;
                justify-content: center;
            }

            .header-left {
                width: auto;
            }

            .sheet-title {
                font-size: 1.1rem;
                margin: 0;
                font-weight: bold;
                text-align: center;
            }

            /* Table Styles */
            table.attendance-table {
                width: 99% !important;
                margin: 0 !important;
                border-collapse: collapse;
                border: 1px solid #000;
                font-size: 8pt;
                table-layout: fixed;
            }

            table.attendance-table th,
            table.attendance-table td {
                height: 18px;
                padding: 0;
                border: 1px solid #000;
                text-align: center;
                vertical-align: middle;
            }

            table.attendance-table th {
                height: 28px;
            }

            /* Print Column Resets - Ensure they fit */
            .col-course {
                width: 9% !important;
                min-width: 0 !important;
            }

            .col-name {
                width: 5% !important;
                min-width: 0 !important;
            }

            .col-no {
                width: 2.5% !important;
                min-width: 0 !important;
            }

            .col-note {
                width: 4% !important;
                min-width: 0 !important;
            }

            .col-day {
                width: auto !important;
                min-width: 0 !important;
            }

            /* Status Colors */
            .stat-present {
                color: #00C240 !important;
            }

            .stat-absent {
                color: #EF4444 !important;
            }

            .stat-extension {
                color: #d97706 !important;
                background-color: #FEF3C7 !important;
            }

            .is-holiday-col {
                background-color: #FEE2E2 !important;
            }

            td.cell-disabled {
                background-color: #F3F4F6 !important;
            }

            td.cell-disabled {
                background-color: #F3F4F6 !important;
            }
        }

        /* Custom Modal Styles */
        .custom-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .custom-modal {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            max-width: 320px;
            width: 90%;
            text-align: center;
            animation: modalFadeIn 0.2s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 12px;
            color: #1e293b;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn-modal {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9rem;
            transition: background 0.1s;
        }

        /* Note Indicator (Red Triangle) */
        .has-note {
            position: relative;
        }

        .has-note::after {
            content: '';
            position: absolute;
            top: 2px;
            right: 2px;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-top: 6px solid #EF4444;
            /* Red triangle */
            z-index: 5;
        }

        .btn-cancel {
            background: #f1f5f9;
            color: #64748b;
        }

        .btn-cancel:hover {
            background: #e2e8f0;
        }

        .btn-confirm {
            background: #ef4444;
            color: white;
        }

        .btn-confirm:hover {
            background: #dc2626;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="brand-logo">
                <span class="logo-text">세종요리</span>
            </div>
            <div class="nav-category">수강 관리</div>
            <a href="index.html" class="nav-item">수강생 관리</a>
            <a href="register.html" class="nav-item">회원 등록</a>
            <a href="sheet.html" class="nav-item active">월간 출석부</a>
            <a href="tuition.html" class="nav-item">수강료 관리</a>
            <div class="nav-category">소통</div>
            <a href="#" class="nav-item">학원 공지</a>
            <a href="feed.html" class="nav-item">피드 관리</a>
            <div class="nav-category">기타</div>
            <a href="stats.html" class="nav-item">통계 및 납부</a>
            <a href="monitor.html" target="_blank" class="nav-item highlight">키오스크 모니터</a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-wrapper">
            <header class="top-header">
                <div class="page-title">
                    <h1>월간 출석부</h1>
                </div>
            </header>

            <div class="content-scroll">
                <div class="sheet-container">

                    <div class="sheet-header">
                        <div class="header-left">
                            <div class="month-nav">
                                <button onclick="changeMonth(-1)">&lt;</button>
                                <div style="display: flex; gap: 5px; align-items: center;">
                                    <select id="yearSelect" class="form-select"
                                        style="border:none; font-weight:700; font-size:1.1rem; padding: 0 10px; width: auto; cursor: pointer; background: transparent;">
                                        <!-- Populated by JS -->
                                    </select>
                                    <select id="monthSelect" class="form-select"
                                        style="border:none; font-weight:700; font-size:1.1rem; padding: 0 10px; width: auto; cursor: pointer; background: transparent;">
                                        <option value="1">1월</option>
                                        <option value="2">2월</option>
                                        <option value="3">3월</option>
                                        <option value="4">4월</option>
                                        <option value="5">5월</option>
                                        <option value="6">6월</option>
                                        <option value="7">7월</option>
                                        <option value="8">8월</option>
                                        <option value="9">9월</option>
                                        <option value="10">10월</option>
                                        <option value="11">11월</option>
                                        <option value="12">12월</option>
                                    </select>
                                </div>
                                <button onclick="changeMonth(1)">&gt;</button>
                            </div>
                        </div>
                        <div class="legend">
                            <div class="legend-item"><span class="symbol stat-present">O</span> 출석</div>
                            <div class="legend-item"><span class="symbol stat-absent">X</span> 결석</div>
                            <div class="legend-item"><span class="symbol stat-extension">연장</span> 연장</div>
                        </div>
                    </div>

                    <div class="course-tabs" style="margin-bottom: 10px;">
                        <button class="tab-btn active" onclick="filterCourse('all')">전체</button>
                        <button class="tab-btn" onclick="filterCourse('한식기능사')">한식기능사</button>
                        <button class="tab-btn" onclick="filterCourse('양식기능사')">양식기능사</button>
                        <button class="tab-btn" onclick="filterCourse('일식기능사')">일식기능사</button>
                        <button class="tab-btn" onclick="filterCourse('중식기능사')">중식기능사</button>
                        <button class="tab-btn" onclick="filterCourse('제과기능사')">제과기능사</button>
                        <button class="tab-btn" onclick="filterCourse('제빵기능사')">제빵기능사</button>
                        <button class="tab-btn" onclick="filterCourse('제과+제빵')">제과+제빵</button>
                        <button class="tab-btn" onclick="filterCourse('복어기능사')">복어기능사</button>
                        <button class="tab-btn" onclick="filterCourse('산업기사')">산업기사</button>
                        <button class="tab-btn" onclick="filterCourse('가정요리')">가정요리</button>
                        <button class="tab-btn" onclick="filterCourse('브런치')">브런치</button>
                    </div>

                    <!-- Time Tabs -->
                    <div class="course-tabs time-tabs" style="margin-bottom: 15px;">
                        <span style="font-weight:bold; margin-right:10px;">시간:</span>
                        <button class="tab-btn active" onclick="filterTime('all')" data-time="all">전체</button>
                        <button class="tab-btn" onclick="filterTime('10:00')" data-time="10:00">오전 10:00</button>
                        <button class="tab-btn" onclick="filterTime('11:00')" data-time="11:00">오전 11:00</button>
                        <button class="tab-btn" onclick="filterTime('14:00')" data-time="14:00">오후 02:00</button>
                        <button class="tab-btn" onclick="filterTime('17:00')" data-time="17:00">오후 05:00</button>
                        <button class="tab-btn" onclick="filterTime('19:00')" data-time="19:00">오후 07:00</button>
                    </div>

                    <table class="attendance-table" id="sheetTable">
                        <thead id="tableHead">
                            <!-- JS Injected -->
                        </thead>
                        <tbody id="sheetBody">
                            <!-- JS Injected -->
                        </tbody>
                    </table>

                    <div class="help-tip">
                        * 날짜 숫자 클릭: 휴일 지정 | 셀 클릭: O/X/연장 | 셀 우클릭: 직접 입력 | * 년월 클릭 시 달력 선택 가능
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="confirmModal" class="custom-modal-overlay">
        <div class="custom-modal">
            <div class="modal-title" id="confirmMessage">삭제하시겠습니까?</div>
            <div class="modal-buttons">
                <button class="btn-modal btn-cancel" onclick="closeConfirmModal(false)">취소</button>
                <button class="btn-modal btn-confirm" onclick="closeConfirmModal(true)">삭제</button>
            </div>
        </div>
    </div>

    <!-- Custom Input Modal -->
    <div id="inputModal" class="custom-modal-overlay">
        <div class="custom-modal">
            <div class="modal-title" id="inputMessage"
                style="white-space: pre-line; text-align: left; font-size: 0.95rem; margin-bottom:16px;"></div>
            <input type="text" id="inputField"
                style="width: 100%; box-sizing: border-box; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 1rem; margin-bottom: 20px;"
                placeholder="내용 입력">
            <div class="modal-buttons">
                <button class="btn-modal btn-cancel" onclick="closeInputModal(false)">취소</button>
                <button class="btn-modal btn-confirm" onclick="closeInputModal(true)"
                    style="background-color: var(--primary-color);">확인</button>
            </div>
        </div>
    </div>

    <button class="print-btn" onclick="window.print()">
        <span class="material-icons">print</span> 인쇄하기
    </button>

    <script>
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth() + 1;
        let membersData = [];
        let attendanceData = [];
        let holidaysData = [];
        let currentFilter = 'all';
        let currentTimeFilter = 'all';

        document.addEventListener('DOMContentLoaded', () => {
            initYearOptions();
            initSheet();

            // Select Listeners
            document.getElementById('yearSelect').addEventListener('change', (e) => {
                currentYear = parseInt(e.target.value);
                renderSheet();
            });
            document.getElementById('monthSelect').addEventListener('change', (e) => {
                currentMonth = parseInt(e.target.value);
                renderSheet();
            });
        });

        function initYearOptions() {
            const yearSelect = document.getElementById('yearSelect');
            if (!yearSelect) return;
            yearSelect.innerHTML = '';
            for (let y = 2025; y <= 3000; y++) {
                const opt = document.createElement('option');
                opt.value = y;
                opt.textContent = `${y}년`;
                if (y === currentYear) opt.selected = true;
                yearSelect.appendChild(opt);
            }
            document.getElementById('monthSelect').value = currentMonth;
        }

        function openMonthPicker() {
            const picker = document.getElementById('monthPicker');
            // Set to 1st of current month to ensure calendar opens in right month
            const mm = String(currentMonth).padStart(2, '0');
            picker.value = `${currentYear}-${mm}`;

            try {
                picker.showPicker();
            } catch (e) {
                // Fallback
                picker.style.visibility = 'visible';
                picker.focus();
                picker.click();
                picker.style.visibility = 'hidden';
            }
        }

        async function initSheet() {
            await Promise.all([fetchMembers(), fetchAttendance(), fetchHolidays()]);
            renderSheet();
        }

        async function fetchMembers() {
            const res = await fetch('/api/members');
            membersData = await res.json();
            // Sort by course then name
            membersData.sort((a, b) => {
                if (a.course !== b.course) return (a.course || '').localeCompare(b.course || '');
                return a.name.localeCompare(b.name);
            });
        }

        async function fetchAttendance() {
            const res = await fetch('/api/attendance');
            attendanceData = await res.json();
        }

        async function fetchHolidays() {
            try {
                const res = await fetch('/api/holidays');
                if (res.ok) holidaysData = await res.json();
            } catch (e) { console.error(e); }
        }

        function filterCourse(course) {
            currentFilter = course;
            // Update Course Tabs Only
            const container = document.querySelector('.course-tabs:not(.time-tabs)');
            if (container) {
                container.querySelectorAll('.tab-btn').forEach(btn => {
                    if (btn.textContent === course || (course === 'all' && btn.textContent === '전체')) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            }
            renderSheet();
        }

        function filterTime(time) {
            currentTimeFilter = time;
            // Update Time Tabs Only
            const container = document.querySelector('.time-tabs');
            if (container) {
                container.querySelectorAll('.tab-btn').forEach(btn => {
                    if (btn.dataset.time === time) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            }
            renderSheet();
        }

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 12) {
                currentMonth = 1;
                currentYear += 1;
            } else if (currentMonth < 1) {
                currentMonth = 12;
                currentYear -= 1;
            }

            // Sync Selects
            document.getElementById('yearSelect').value = currentYear;
            document.getElementById('monthSelect').value = currentMonth;

            renderSheet();
        }

        function renderSheet() {
            // Updated to sync select value if needed, but changeMonth handles it.
            // Just ensure yearSelect matches currentYear
            document.getElementById('yearSelect').value = currentYear;
            document.getElementById('monthSelect').value = currentMonth;


            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            const thead = document.getElementById('tableHead');
            thead.innerHTML = '';

            const trHead = document.createElement('tr');

            // 1. Static Headers
            // Custom first header for Course Name + Time + Registered Date
            let courseNameDisplay = currentFilter === 'all' ? '전체과정' : currentFilter;
            if (currentTimeFilter !== 'all') {
                const timeLabel = currentTimeFilter === '10:00' ? '오전 10시' :
                    currentTimeFilter === '17:00' ? '오후 5시' :
                        currentTimeFilter === '19:00' ? '오후 7시' : currentTimeFilter;
                courseNameDisplay += ` (${timeLabel})`;
            }

            const thCourse = document.createElement('th');
            thCourse.className = 'col-course';
            thCourse.innerHTML = `<div style="font-size:0.9em; line-height:1.2; font-weight:bold; color:#000;">${courseNameDisplay}</div><div style="font-size:0.75em; font-weight:normal; color:#333;">등록일</div>`;
            trHead.appendChild(thCourse);

            const headers = [
                { text: '성 명', cls: 'col-name' },
                { text: '순번', cls: 'col-no' }
            ];

            headers.forEach(h => {
                const th = document.createElement('th');
                th.textContent = h.text;
                th.className = h.cls;
                trHead.appendChild(th);
            });

            // 2. Day Headers (1 ~ 31)
            const dayNames = ['일', '월', '화', '수', '목', '금', '토'];
            for (let i = 1; i <= 31; i++) {
                const th = document.createElement('th');
                th.className = 'col-day';

                if (i <= daysInMonth) {
                    const dateObj = new Date(currentYear, currentMonth - 1, i);
                    const dayOfWeek = dateObj.getDay();

                    // Number + DayName
                    th.innerHTML = `${i}<br><span style="font-size:0.65em; font-weight:normal;">${dayNames[dayOfWeek]}</span>`;

                    if (dayOfWeek === 0) th.classList.add('is-sunday');
                    if (dayOfWeek === 6) th.classList.add('is-saturday');

                    const dateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    const isHoliday = holidaysData.find(h => h.date === dateStr);
                    if (isHoliday) th.classList.add('is-holiday-col');

                    th.onclick = () => toggleHoliday(dateStr);
                } else {
                    // Invalid days (e.g. Feb 30)
                    th.textContent = i;
                    th.style.color = '#ccc';
                    th.style.backgroundColor = '#fcfcfc';
                }

                trHead.appendChild(th);
            }

            // 3. Note Header
            const thNote = document.createElement('th');
            thNote.textContent = '비 고';
            thNote.className = 'col-note';
            trHead.appendChild(thNote);

            thead.appendChild(trHead);

            // Filter Data
            let filteredMembers = membersData;
            if (currentFilter !== 'all') {
                // Support multi-value course string "A,B"
                filteredMembers = filteredMembers.filter(m => m.course && m.course.includes(currentFilter));
            }
            if (currentTimeFilter !== 'all') {
                filteredMembers = filteredMembers.filter(m => m.timeSlot === currentTimeFilter);
            }

            // Body
            // Body - Fixed 20 Rows
            const tbody = document.getElementById('sheetBody');
            tbody.innerHTML = '';

            for (let r = 0; r < 20; r++) {
                const tr = document.createElement('tr');
                const m = filteredMembers[r]; // May be undefined

                // Col 1: Registered Date
                const tdCourse = document.createElement('td');
                if (m && m.registeredDate) {
                    const shortDate = m.registeredDate.replace(/-/g, '.').substring(2);
                    tdCourse.textContent = shortDate;
                } else {
                    tdCourse.textContent = '';
                }
                tr.appendChild(tdCourse);

                // Col 2: Name
                const tdName = document.createElement('td');
                tdName.textContent = m ? m.name : '';
                if (m) tdName.style.fontWeight = 'bold';
                tr.appendChild(tdName);

                // Col 3: No
                const tdNo = document.createElement('td');
                tdNo.textContent = String(r + 1).padStart(2, '0');
                tr.appendChild(tdNo);

                // Days (Always 1-31)
                for (let i = 1; i <= 31; i++) {
                    const td = document.createElement('td');
                    td.className = 'cell-check';

                    if (i <= daysInMonth) {
                        const dateStr = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                        const isHoliday = holidaysData.find(h => h.date === dateStr);
                        const dayOfWeek = new Date(currentYear, currentMonth - 1, i).getDay();

                        if (dayOfWeek === 0 || isHoliday) {
                            td.classList.add('cell-disabled');
                        } else {
                            if (m) {
                                // Real Member Data

                                // Course Schedule Logic
                                const COURSE_SCHEDULE = {
                                    '한식기능사': [1, 3], // Mon, Wed
                                    '양식기능사': [2, 4], // Tue, Thu
                                    '중식기능사': [2, 4],
                                    '일식기능사': [2, 4],
                                    '가정요리': [2, 4],
                                    '브런치': [5],        // Fri
                                    '복어기능사': [5]
                                };

                                let allowedDays = [];
                                if (m.course) {
                                    // Parse all courses strings
                                    Object.keys(COURSE_SCHEDULE).forEach(courseName => {
                                        if (m.course.includes(courseName)) {
                                            allowedDays.push(...COURSE_SCHEDULE[courseName]);
                                        }
                                    });
                                }

                                // If member has courses but none matched schedule (e.g. baking), or no course listed, default to ALL allowed?
                                // User request implies specific restriction. 
                                // Let's say if allowedDays is empty and they have a course that ISN'T in the list (e.g. 제과), maybe default to all?
                                // "만 체크할수 있도록" implies strictness.
                                // But what about "제과기능사"? The user didn't specify. Assuming "Others" = All days or No restrictions mentioned.
                                // Let's assume if allowedDays is empty, it means "Open" (or maybe the user wants to strict it?)
                                // "Others (Baking, Bread, etc.)" should be Always enabled per my plan.
                                // Simple logic: If m.course is present, and we found NO matches in SCHEDULE, assume it's an "Unrestricted" course -> Allow All.
                                // If we found matches (e.g. "Hansik"), then strictly follow allowedDays.
                                // Special case: a user with "Hansik" (Mon/Wed) AND "Baking" (All?). 
                                // If "Baking" implies all days, then union is All Days.
                                // How to detect "Baking"?
                                // Let's check if the user has ONLY scheduled courses.
                                const scheduledCourses = Object.keys(COURSE_SCHEDULE);
                                const hasScheduledCourse = m.course && scheduledCourses.some(c => m.course.includes(c));

                                // If they have a scheduled course, we enforce the schedule.
                                // UNLESS they also have an unscheduled course? 
                                // "제과" was not in the list. 
                                // Let's assume strict union of explicitly defined days. 
                                // If they have "Hansik" (Mon, Wed) and "Baking" (Unspecified -> All), logic should probably allow All?
                                // For now, let's implement strict checking for the listed ones.
                                // If allowedDays is empty, we set it to [0,1,2,3,4,5,6] (All)
                                if (allowedDays.length === 0) {
                                    allowedDays = [0, 1, 2, 3, 4, 5, 6];
                                } else {
                                    // Deduplicate
                                    allowedDays = [...new Set(allowedDays)];
                                }

                                const currentDayOfWeek = new Date(currentYear, currentMonth - 1, i).getDay();
                                const isAllowed = allowedDays.includes(currentDayOfWeek);

                                if (!isAllowed) {
                                    td.classList.add('cell-disabled');
                                    td.style.backgroundColor = '#f5f5f5'; // Light gray
                                    td.style.cursor = 'not-allowed';
                                    // Prevent interactions? 
                                    // existing logic below handles clicks but we should guard.
                                    // However, what if they want to view old data? 
                                    // Usually disabled cells shouldn't be toggleable.
                                } else {
                                    // Interactive Cell Configuration
                                    td.dataset.mid = m.id;
                                    td.dataset.date = dateStr;

                                    // Visual Arrow Logic: Check neighbors for 'extension'
                                    const log = attendanceData.find(l => l.memberId === m.id && l.date === dateStr);
                                    let status = log ? log.status : 'unchecked';

                                    // Pre-calculate visuals based on neighbors
                                    if (status === 'extension') {
                                        // Check Prev
                                        const prevDate = new Date(currentYear, currentMonth - 1, i - 1);
                                        const prevDateStr = `${prevDate.getFullYear()}-${String(prevDate.getMonth() + 1).padStart(2, '0')}-${String(prevDate.getDate()).padStart(2, '0')}`;
                                        const prevLog = attendanceData.find(l => l.memberId === m.id && l.date === prevDateStr);
                                        const isPrevExt = prevLog && prevLog.status === 'extension';

                                        // Check Next
                                        const nextDate = new Date(currentYear, currentMonth - 1, i + 1);
                                        const nextDateStr = `${nextDate.getFullYear()}-${String(nextDate.getMonth() + 1).padStart(2, '0')}-${String(nextDate.getDate()).padStart(2, '0')}`;
                                        const nextLog = attendanceData.find(l => l.memberId === m.id && l.date === nextDateStr);
                                        const isNextExt = nextLog && nextLog.status === 'extension';

                                        renderExtensionArrow(td, isPrevExt, isNextExt);
                                    } else {
                                        setCellSymbol(td, status);
                                    }

                                    // Mouse Events for Dragging
                                    td.onmousedown = (e) => handleCellMouseDown(e, m.id, dateStr, td);
                                    td.onmouseover = (e) => handleCellMouseOver(e, m.id, dateStr, td);
                                    td.onmouseup = () => handleCellMouseUp();

                                    // Click Interaction (Toggle)
                                    td.onclick = () => toggleCell(td, m.id, dateStr);

                                    // Context Menu (Right Click)
                                    td.oncontextmenu = (e) => {
                                        e.preventDefault();
                                        editCellText(td, m.id, dateStr);
                                    };
                                }
                            } else {
                                // Empty Row - Non-interactive but preserve aesthetics
                                td.style.pointerEvents = 'none';
                            }
                        }

                        if (isHoliday) td.style.backgroundColor = '#FEE2E2';
                        else if (dayOfWeek === 0) td.style.backgroundColor = '#FEF2F2';
                    } else {
                        // Invalid day cells (e.g. Feb 30)
                        td.classList.add('cell-disabled');
                        td.style.backgroundColor = '#fcfcfc';
                    }

                    tr.appendChild(td);
                }

                // Note Col (Remarks)
                const tdNote = document.createElement('td');
                if (m) {
                    let text = '';
                    if (m.course) {
                        // m.course is "Course(Time), Course(Time)"
                        // Format nicely: replace comma with <br>
                        text += `<div style="font-weight:bold; font-size:7pt;">${m.course.replace(/, /g, '<br>')}</div>`;
                    }
                    if (m.notes) {
                        if (text) text += '<div style="margin-top:1px; color:#666; font-size:7pt;">' + m.notes + '</div>';
                        else text = `<span style="font-size:7pt;">${m.notes}</span>`;
                    }
                    tdNote.innerHTML = text;
                    tdNote.style.textAlign = 'left';
                    tdNote.style.padding = '2px 4px';
                    tdNote.style.verticalAlign = 'middle';
                    tdNote.style.lineHeight = '1.2';
                }
                tr.appendChild(tdNote);

                tbody.appendChild(tr);
            }
        }

        async function toggleHoliday(dateStr) {
            const isHoliday = !!holidaysData.find(h => h.date === dateStr);
            await saveHoliday(dateStr, !isHoliday);
            await fetchHolidays();
            renderSheet();
        }

        async function saveHoliday(dateStr, isHoliday) {
            try {
                await fetch('/api/holidays', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ date: dateStr, isHoliday })
                });
            } catch (e) { console.error(e); }
        }

        async function saveAttendance(memberId, dateStr, status) {
            // Remove ALL existing entries for this cell to prevent duplicates
            attendanceData = attendanceData.filter(l => !(l.memberId === memberId && l.date === dateStr));

            // Treat 'unchecked' as null/delete
            if (status && status !== 'unchecked') {
                attendanceData.push({ memberId, date: dateStr, status: status });
            }

            // Optimistic UI Update
            // 1. Update local data immediatey (already done above)
            // 2. Render immediately
            renderSheet();

            try {
                await fetch('/api/attendance', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ memberId, date: dateStr, status })
                });
            } catch (e) {
                console.error("Save failed", e);
                alert("저장 실패. 새로고침 해주세요.");
            }
        }

        // ---- Drag Interaction Logic ----
        let isDragging = false;
        let dragStartMemberId = null;
        let dragSelection = new Set(); // Stores date strings

        function handleCellMouseDown(e, memberId, dateStr, td) {
            if (e.button !== 0) return; // Only left click
            if (td.classList.contains('cell-disabled')) return;

            isDragging = true;
            dragStartMemberId = memberId;
            dragSelection.clear();
            dragSelection.add(dateStr);

            // Visual feedback for start of selection?
            // Optional: highlight cell
        }

        function handleCellMouseOver(e, memberId, dateStr, td) {
            if (!isDragging) return;
            if (memberId !== dragStartMemberId) return; // Only same row
            if (td.classList.contains('cell-disabled')) return;

            dragSelection.add(dateStr);
            // Visual feedback: select the cell
            td.style.backgroundColor = '#e0f2fe'; // Light blue highlight during drag
        }

        async function handleCellMouseUp() {
            if (!isDragging) return;
            isDragging = false;

            // If dragging occurred over multiple cells (or strictly intended for Extension)
            // If just 1 cell, treat as click toggle?
            // Let's defer to click handler for single cell to keep toggle logic
            if (dragSelection.size <= 1) {
                // Let onclick handle it (native click event will fire after mouseup)
                // But we need to clean up highlight
                // actually onclick usually fires.
                // Do NOT renderSheet() here, otherwise 'td' element is destroyed before onclick fires.
                if (dragSelection.size === 1) {
                    // If we highlighted it (dragged over self), we might want to clear highlight?
                    // But renderSheet() kills the event. 
                    // The click will trigger save -> renderSheet anyway.
                }
                return;
            }

            // Apply 'extension' to all selected
            if (dragSelection.size > 1) {
                await applyStatusToBatch(dragStartMemberId, Array.from(dragSelection), 'extension');
            }
            dragSelection.clear();
            dragStartMemberId = null;
        }

        // Global mouseup to catch releases outside cells
        document.addEventListener('mouseup', () => {
            if (isDragging) handleCellMouseUp();
        });

        async function applyStatusToBatch(memberId, dates, status) {
            // Update local state first for speed
            dates.forEach(date => {
                const idx = attendanceData.findIndex(l => l.memberId === memberId && l.date === date);
                if (idx !== -1) attendanceData[idx].status = status;
                else attendanceData.push({ memberId, date, status });
            });
            renderSheet(); // Re-render first to show arrow

            // Send to server
            try {
                await fetch('/api/attendance/batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ memberId, dates, status })
                });
            } catch (e) {
                console.error(e);
                alert('저장 실패');
            }
        }

        // ---- Visual Logic ----
        function renderExtensionArrow(td, isPrevExt, isNextExt) {
            td.innerHTML = '';
            td.className = ''; // reset
            td.classList.add('stat-extension');
            td.style.position = 'relative';
            td.style.color = 'transparent'; // Hide text if any

            // Draw arrow using CSS or characters
            // Simplest: use text content with lines
            // Start: O--
            // Mid: ---
            // End: -->
            // Single: 연장 (Just text)

            if (!isPrevExt && !isNextExt) {
                // Single cell extension
                setCellSymbol(td, 'extension');
                return;
            }

            // Continuous Arrow
            const arrowContainer = document.createElement('div');
            arrowContainer.style.width = '100%';
            arrowContainer.style.height = '100%';
            arrowContainer.style.display = 'flex';
            arrowContainer.style.alignItems = 'center';
            arrowContainer.style.justifyContent = 'center';
            arrowContainer.style.fontWeight = 'bold';
            arrowContainer.style.color = '#d97706'; // Extension color

            if (!isPrevExt && isNextExt) {
                // Start
                arrowContainer.textContent = '● ──';
            } else if (isPrevExt && isNextExt) {
                // Mid
                arrowContainer.textContent = '───';
            } else if (isPrevExt && !isNextExt) {
                // End
                arrowContainer.textContent = '── ▶';
            }
            td.appendChild(arrowContainer);
        }

        function setCellSymbol(td, status) {
            td.innerHTML = ''; // Clear content
            td.className = 'cell-check';
            td.style.fontSize = '0.75rem';
            td.title = '';
            td.classList.remove('has-note');

            if (!status) return;

            // Helper to check keywords
            const isAbsent = status === 'absent' || status.includes('결석') || status.includes('X');
            const isExtension = status === 'extension' || status.includes('연장');
            const isPresent = status === 'present' || status.includes('출석') || status === 'O';

            let badgeHtml = '';
            let hasExtraText = false;

            if (isPresent) {
                // O badge (Green)
                badgeHtml = '<span class="symbol stat-present">O</span>';
                hasExtraText = status.length > 2 && status !== 'present'; // "출석" or "출석 ..."
            } else if (isAbsent) {
                // X badge (Red)
                // If it's just 'X' or 'absent', show X. If '결석', show X.
                // If '결석 사유', show X + Note.
                badgeHtml = '<span class="symbol stat-absent">X</span>';
                hasExtraText = status !== 'absent' && status !== 'X';
            } else if (isExtension) {
                // Extension badge (Orange)
                badgeHtml = '<span class="symbol stat-extension">연장</span>';
                hasExtraText = status !== 'extension' && status !== '연장';
            } else if (status === 'unchecked') {
                return;
            } else {
                // Custom text (other)
                td.classList.add('stat-text');
                td.textContent = status;
                return;
            }

            td.innerHTML = badgeHtml;

            // Add Note Marker if there is extra text
            if (hasExtraText) {
                td.classList.add('has-note');
                td.title = status; // Tooltip shows full text
            }
        }

        function toggleCell(td, memberId, dateStr) {
            // Prevent toggle if we just dragged (checked via selection size check above, but safer to rely on flag if needed)
            // But dragging consumes mouseup. Onclick fires after mouseup.
            // If we re-rendered in mouseup, the cell element might be replaced? 
            // In renderSheet, innerHTML is cleared. So if re-rendered, 'td' is dead. 
            // So onclick won't fire on the *new* element.
            // So we are safe.

            if (td.classList.contains('cell-disabled')) return;

            // Logic to cycle status
            // present -> absent -> extension -> text(keep) -> delete -> present

            // Check current status from DATA, not class, to be safe source of truth
            const log = attendanceData.find(l => l.memberId === memberId && l.date === dateStr);
            const currentStatus = log ? log.status : 'checked'; // actually 'unchecked' is null log

            let nextStatus = 'present';
            if (log) {
                const s = log.status;
                const isPresent = s === 'present' || s === 'O' || s.includes('출석');
                const isAbsent = s === 'absent' || s === 'X' || s.includes('결석');
                const isExtension = s === 'extension' || s.includes('연장');

                if (isPresent) nextStatus = 'absent';
                else if (isAbsent) nextStatus = 'extension';
                else if (isExtension) nextStatus = 'unchecked'; // Remove
                else nextStatus = 'unchecked'; // text or other -> remove
            }

            // Delete Confirmation
            if (nextStatus === 'unchecked') {
                showConfirmModal("삭제하시겠습니까?", () => {
                    saveAttendance(memberId, dateStr, 'unchecked');
                });
                return;
            }

            // Save
            saveAttendance(memberId, dateStr, nextStatus);
        }



        function editCellText(td, memberId, dateStr) {
            if (td.classList.contains('cell-disabled')) return;
            const currentText = td.textContent.trim();
            const isExtension = td.querySelector('.stat-extension') || currentText.includes('연장');
            const isAbsent = td.querySelector('.stat-absent') || ['X', '결석'].includes(currentText);

            let initial = '';

            // Smart Pre-fill
            if (isExtension) {
                initial = currentText === '연장' ? '연장 ' : currentText;
            } else if (isAbsent) {
                initial = currentText === 'X' ? '결석 ' : currentText;
            } else {
                initial = ['O'].includes(currentText) ? '' : currentText;
            }

            const promptMsg = "입력할 내용을 적어주세요 (예: 조퇴, 지각)\n* 내용을 지우면 삭제됩니다.\n* '연장' 또는 '결석' 단어가 포함되면 색상이 유지됩니다.";

            showInputModal(promptMsg, initial, (newText) => {
                if (newText === null) return; // Cancelled

                // empty input -> 'unchecked' (delete)
                const finalStatus = newText.trim() === '' ? 'unchecked' : newText.trim();

                if (finalStatus === 'unchecked') {
                    // Close input modal first logic is handled by showInputModal calling callback AFTER closing
                    // But we want to show Confirm modal. 
                    // Since modals use same overlay stacking or just replace?
                    // Implementation: closeInputModal hides logic. confirmModal will show.

                    // Small delay to ensure clean visual transition? Not strictly needed but safer.
                    setTimeout(() => {
                        showConfirmModal("삭제하시겠습니까?", () => {
                            setCellSymbol(td, finalStatus);
                            saveAttendance(memberId, dateStr, finalStatus);
                        });
                    }, 50);
                    return;
                }

                setCellSymbol(td, finalStatus);
                saveAttendance(memberId, dateStr, finalStatus);
            });
        }

        // ---- Modal Logic ----
        let confirmCallback = null;
        let inputCallback = null;

        function showConfirmModal(message, onConfirm) {
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmModal').style.display = 'flex';
            confirmCallback = onConfirm;
        }

        function closeConfirmModal(isConfirmed) {
            document.getElementById('confirmModal').style.display = 'none';
            if (isConfirmed && confirmCallback) {
                confirmCallback();
            }
            confirmCallback = null;
        }

        function showInputModal(message, initialValue, onInput) {
            document.getElementById('inputMessage').textContent = message;
            const input = document.getElementById('inputField');
            input.value = initialValue;
            document.getElementById('inputModal').style.display = 'flex';
            input.focus();

            // Handle Enter key
            input.onkeydown = (e) => {
                if (e.key === 'Enter') closeInputModal(true);
            };

            inputCallback = onInput;
        }

        function closeInputModal(isConfirmed) {
            document.getElementById('inputModal').style.display = 'none';
            const value = document.getElementById('inputField').value;
            if (inputCallback) {
                if (isConfirmed) inputCallback(value);
                else inputCallback(null);
            }
            inputCallback = null;
        }
    </script>
</body>

</html>